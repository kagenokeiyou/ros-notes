# 参数（Parameter）

ROS 2 中的参数与单个节点相关联。参数用于在启动时（以及运行时）配置节点，而无需更改代码。参数的生命周期与节点的生命周期相关联（尽管节点可以实现某种持久化机制，以便在重新启动后重新加载值）。

参数通过节点名称、节点命名空间、参数名称和参数命名空间来寻址。提供参数命名空间是可选的。

每个参数由一个键、一个值和一个描述符组成。键是一个字符串，值可以是以下类型之一： `bool` 、 `int64` 、 `float64` 、 `string` 、 `byte[]` 、 `bool[]` 、 `int64[]` 、 `float64[]` 或 `string[]` 。默认情况下所有描述符都是空的，但可以包含参数描述、值范围、类型信息以及额外的约束。

## 声明参数

默认情况下，一个节点需要声明其生命周期中将要接受的全部参数。这是为了在节点启动时明确参数的类型和名称，从而减少后续可能出现的配置错误。

对于某些类型的节点，并非所有参数都会提前知晓。在这种情况下，可以将节点的 `allow_undeclared_parameters` 设置为 `true` 进行实例化，这将允许在节点上获取和设置参数，即使这些参数尚未声明。

## 参数类型

ROS 2 节点的每个参数都有一个在概述中提到的预定义参数类型。默认情况下，尝试在运行时更改已声明参数的类型将失败。这可以防止常见的错误，例如将布尔值放入整数参数中。

如果一个参数需要是多种不同的类型，并且使用该参数的代码能够处理这种情况，那么这种默认行为可以被更改。在声明参数时，应该使用 `ParameterDescriptor` 并将 `dynamic_typing` 成员变量设置为 `true`。

## 参数回调函数

ROS 2 节点可以注册三种不同类型的回调函数，以便在参数发生变化时得到通知。这三种回调函数都是可选的。

第一种被称为“预设置参数”回调函数，可以通过从节点 API 调用 `add_pre_set_parameters_callback` 来设置。这个回调函数接收一个正在被改变的 `Parameter` 对象列表，并返回空值。当它被调用时，可以修改 `Parameter` 列表来改变、添加或删除条目。例如，如果 `parameter2` 应该在 `parameter1` 变化时随时改变，那么可以通过这个回调函数来实现。

第二个被称为“设置参数”回调，可以通过从节点 API 调用 `add_on_set_parameters_callback` 来设置。该回调接收一个不可变的 `Parameter` 对象列表，并返回一个 `rcl_interfaces/msg/SetParametersResult`。这个回调的主要目的是让用户能够检查即将对参数进行的更改，并明确拒绝该更改。

> [!Note]
> 重要的是“设置参数”回调不能有副作用。由于多个“设置参数”回调可以链式调用，因此单个回调无法知道后续的回调是否会拒绝更新。如果单个回调对它所在的类进行更改，例如，它可能会与实际参数不同步。要在参数成功更改后获取回调，请查看下一种类型的回调。

第三种类型的回调被称为“设置参数后”回调，可以通过从节点 API 调用 `add_post_set_parameters_callback` 来设置。该回调接收一个不可变的 `Parameter` 对象列表，并返回空值。这个回调的主要目的是让用户能够对已成功接受的参数更改做出反应。

## 与参数交互

ROS 2 节点可以通过节点 API 执行参数操作。外部进程可以通过节点实例化时默认创建的参数服务执行参数操作。默认创建的服务包括：

- `/node_name/describe_parameters` : 使用 `rcl_interfaces/srv/DescribeParameters` 类型的服务。给定参数名称列表，返回与参数关联的描述符列表。
- `/node_name/get_parameter_types` : 使用 `rcl_interfaces/srv/GetParameterTypes` 类型的服务。给定参数名称列表，返回与参数关联的参数类型列表。
- `/node_name/get_parameters` : 使用 `rcl_interfaces/srv/GetParameters` 类型的服务。给定一组参数名称，返回与这些参数关联的值列表。
- `/node_name/list_parameters` : 使用 `rcl_interfaces/srv/ListParameters` 类型的服务。给定一个可选的参数前缀列表，返回具有该前缀的可用参数列表。如果前缀为空，则返回所有参数。
- `/node_name/set_parameters` : 使用 `rcl_interfaces/srv/SetParameters` 类型的服务。给定一组参数名称和值，尝试在节点上设置这些参数。返回尝试设置每个参数的结果列表；其中一些可能成功，而另一些可能失败。
- `/node_name/set_parameters_atomically` : 使用 `rcl_interfaces/srv/SetParametersAtomically` 类型的服务。给定一组参数名称和值，尝试在节点上设置这些参数。返回尝试设置所有参数的单个结果，因此如果其中一个失败，所有都将失败。

## 运行节点时设置初始参数值

在运行节点时，可以通过单独的命令行参数或 YAML 文件设置初始参数值。

## 启动节点时设置初始参数值

初始参数值也可以通过 ROS 2 启动功能设置。

# 在运行时操作参数值

`ros2 param` 命令是与已运行节点的参数进行交互的通用方式。 `ros2 param` 使用上述描述的参数服务 API 来执行各种操作。有关如何使用 `ros2 param` 的详细信息，请参阅此操作指南。
